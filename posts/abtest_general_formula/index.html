<!DOCTYPE html>
<html lang="">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Lluc Puig Codina">
    <meta name="description" content="https://llucpuigcodina.github.io">
    <meta name="keywords" content="blog, economics,personal">
    
    <meta property="og:site_name" content="Lluc Puig Codina">
    <meta property="og:title" content="Lluc Puig Codina">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://llucpuigcodina.github.io/posts/abtest_general_formula/">
    <meta property="og:image" content="https://llucpuigcodina.github.io">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="https://llucpuigcodina.github.io/posts/abtest_general_formula/">
    <meta name="twitter:image" content="https://llucpuigcodina.github.io">

    <base href="https://llucpuigcodina.github.io">
    <title>
  X &gt; MAX for independent but not identically distributed betas - Lluc Puig Codina
</title>

    <link rel="canonical" href="https://llucpuigcodina.github.io/posts/abtest_general_formula/">
    
    <link  rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700">
    <link rel="stylesheet" href="//cdn.rawgit.com/necolas/normalize.css/master/normalize.css">
    <link rel="stylesheet" href="https://llucpuigcodina.github.io/css/style.min.css">

    

    

    <link rel="icon" type="image/png" href="https://llucpuigcodina.github.io/images/logo.png" sizes="32x32"/>

    

    <meta name="generator" content="Hugo 0.89.2" />
  </head>

  <body class="">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">Lluc Puig Codina</a>
    <input type="checkbox" id="menu-control"/>
    <label class="menu-mobile  float-right " for="menu-control">
      <span class="btn-mobile  float-right ">&#9776;</span>
      <ul class="navigation-list">
        
          
            <li class="navigation-item  align-center ">
              <a class="navigation-link" href="https://llucpuigcodina.github.io/research/">Research</a>
            </li>
          
            <li class="navigation-item  align-center ">
              <a class="navigation-link" href="https://llucpuigcodina.github.io/teaching/">Teaching</a>
            </li>
          
            <li class="navigation-item  align-center ">
              <a class="navigation-link" href="https://llucpuigcodina.github.io/posts/">Blog</a>
            </li>
          
        
      </ul>
    </label>
  </section>
  

    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
    
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": {
            styles: {'.MathJax_Display': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
    </script>
    
</nav>


      <div class="content">
        
  <section class="container post">
  <article>
    <header>
      <h1 class="title">X &gt; MAX for independent but not identically distributed betas</h1>
      <h2 class="date">October 13, 2023</h2>

      
    </header>

    


<style>
body {
text-align: justify}
</style>
<p>In this post I provide a general formula for the probability that the realization of a beta random variable is larger than the realizations from a sequence of beta random variables, all of them being independent. Assume <span class="math inline">\(p_j \sim \mathscr{B}(\alpha_j, \beta_j)\)</span>. We have J+1 independent but not identically distributed beta random variables, indexed from 0 to J, and we are interested in calculating <span class="math inline">\(\mathbb{P}(p_0 &gt; max\{p_1,\dots,p_J\})\)</span>. <span class="math inline">\(\alpha_j\)</span>’s and <span class="math inline">\(\beta_j\)</span>’s are restricted to the positive integers. A general recursive formula in the style of the ones provided by <a href="https://www.evanmiller.org/bayesian-ab-testing.html#binary_abc">Evan Miller</a> is:</p>
<span class="math display">\[\begin{gather*}
\mathbb{P}(p_0 &gt; max\{p_1,\dots,p_J\}) = \mathbb{P}(p_0(\alpha_0, \beta_0) &gt; max \{p_1,\dots, p_{J-1}\}) + \\ - \frac{1}{B(\alpha_0,\beta_0)\Gamma(\beta_J)} \sum_{i=1}^{\alpha_J}\frac{B(\alpha_0 + i -1, \beta_0 + \beta_J)\Gamma(\beta_J + i -1)}{\Gamma(i)} \mathbb{P}(p_0(\alpha_0 + i -1, \beta_0+ \beta_J) &gt; max\{p_1,\dots,p_{J-1}\})
\end{gather*}\]</span>
<p>where</p>
<span class="math display">\[\begin{aligned}
\mathbb{P}(p_g &gt; p_m) = \frac{1}{B(\alpha_m, \beta_m)}\sum_{i = 1}^{\alpha_g}\frac{B(\alpha_m + i - 1, \beta_g + \beta_m)}{(\beta_g+i-1)B(i,\beta_g)}

\end{aligned}\]</span>
<p><span class="math inline">\(B\)</span> denotes the beta function and <span class="math inline">\(\Gamma\)</span> the gamma function. This object is typically of interest in the Beta-Binomial model and the Bayesian analysis of binary outcome Randomized Control Trials (A/B tests), where the prior on the probability of success is given by (conjugate) independent beta distributions. Note that that the restriction on the parameters can accommodate Haldane’s prior of <span class="math inline">\(\mathscr{B}(0,0)\)</span> as long as there are at least one success and one failure for that <span class="math inline">\(j\)</span> and the uniform prior of <span class="math inline">\(\mathscr{B}(1,1)\)</span>.</p>
<p>Due to the reduction in dimension on the <span class="math inline">\(max\)</span> operator, it is a guarantee that the first equation will end up evaluating a bunch of the bottom equations. Each step reduces the dimension in 1 but requires <span class="math inline">\(\alpha_j+1\)</span> evaluations of the formula again so it’s computable in <span class="math inline">\(\mathcal{O}\left(\prod_{j=1}^J(\alpha_j+1)\right)\)</span> time. The formula can also be re-derived such that the sums happen over the <span class="math inline">\(\beta_j\)</span>’s, instead of the <span class="math inline">\(\alpha_j\)</span>’s but since the number of successes are typically much smaller than the failures it is more efficient to use the one provided here. They could also be combined, alternating to deliver computational time in <span class="math inline">\(\mathcal{O}\left(\prod_{j=1}^J \min \{\alpha_j+1, \beta_j +1\} \right)\)</span>.</p>
<p>This formula adds to what was already provided by Miller. Since calculation is quite burdensome I provide here a general R function based on the recursive nature of the formula. Memoization should substantially improve the performance of the function presented here. I do not know whether someone else has derived this formula elsewhere. I have searched for a bit but haven’t found it, so I would appreciate if someone pointed me to such formula being discovered. At the end I provide a sketch of the proof.</p>
<p>To calculate <span class="math inline">\(\mathbb{P}(p_i &gt; max\{p_0, p_1, \dots, p_{i-1}, p_{i+1}, \dots p_J\})\)</span> one only needs to reorder the <span class="math inline">\(\alpha_j\)</span>’s and <span class="math inline">\(\beta_j\)</span>’s appropriately. From simple rules of probability where <span class="math inline">\(P(A_1 \cap A_2) = P(A_1) - P(A_1 - A_2)\)</span> we can obtain that the negative term corresponds to the probability of the following event: <span class="math inline">\(p_J &gt; p_0 &gt; max\{p_1,\dots,p_{J-1}\}\)</span>; that <span class="math inline">\(p_J\)</span> is the largest and <span class="math inline">\(p_0\)</span> the second largest. This object could also be of interest, specially due to the possibility of reordering to calculate any event of the type <span class="math inline">\(p_k &gt; p_g &gt; max\{p_1,\dots,p_{k-1},p_{k+1}, \dots,p_{g-1},p_{g+1},\dots,p_J\}\)</span> and possibly other sequences of inequalities by going down the recursive rabbit hole. The relation with order statistics as just seen and the recursive nature (combinatorial or exponentially increasing evaluations), give some <a href="https://en.wikipedia.org/wiki/Bapat%E2%80%93Beg_theorem">Bapat-Beg Theorem</a> taste. It also makes me suspect of a close relationship between the maximum of beta random variables and the beta distribution itself.</p>
<pre class="r"><code>ProbGBeatsM &lt;- function(ag, bg, am, bm){
  Bf &lt;- sapply(1:ag, function(i) {exp(lbeta(am + i - 1, bg + bm) - 
                                            log(bg + i - 1) - lbeta(i, bg))})  
  return(sum(Bf)/beta(am,bm))  
}

InnerTerm &lt;- function(i, a0, b0, bJ, aS, bS){
  return(exp(lbeta(a0 + i - 1, b0 + bJ) + lgamma(bJ + i - 1) - lgamma(i)
             )*Prob0beatsAll(a0 + i - 1, b0 + bJ, head(aS, -1), head(bS, -1)) )  
}

Prob0beatsAll &lt;- function(alpha0, beta0, alpha_, beta_){
  
  J = length(alpha_)
  
  if (J == 1) {
    
    return(ProbGBeatsM(alpha0, beta0, alpha_, beta_))
  
    } else {

      return( Prob0beatsAll(alpha0, beta0, head(alpha_, -1), head(beta_, -1))
                - sum(sapply(1:alpha_[J], InnerTerm, a0 = alpha0, b0 = beta0, bJ = beta_[J],
                                aS = alpha_, bS = beta_))*exp(-lbeta(alpha0, beta0) - lgamma(beta_[J])) )
      }
}</code></pre>
<pre class="r"><code>alpha0 = 5
beta0 = 8
alpha_ &lt;- c(5,5,5,5)
beta_ &lt;- c(8,8,8,8)

print(Prob0beatsAll(alpha0, beta0, alpha_, beta_)) # This confirms the 1/(J+1) case of iid variables.</code></pre>
<pre><code>## [1] 0.2</code></pre>
<div id="proof-sketch" class="section level3">
<h3>Proof Sketch</h3>
<p>With some notational abuse:</p>
<span class="math display">\[\begin{aligned}
\mathbb{P}(p_0 &gt; max\{p_1,\dots,p_J\}) &amp;= \int_0^1 \int_0^{p_0} \int_0^{p_0} \cdots \int_0^{p_0} \prod_{j=0}^J f_{j}(p_{j}) dj = \int_0^1 \prod_{j=1}^{J-1} \mathbb{I}_{p_0}(\alpha_j,\beta_j) \frac{p_0^{\alpha_0-1}(1-p_0)^{\beta_0-1}}{B(\alpha_0, \beta_0)} \mathbb{I}_{p_0}(\alpha_J,\beta_J) dp_0 \\
&amp;=  \int_0^1 \prod_{j=1}^{J-1} \mathbb{I}_{p_0}(\alpha_j,\beta_j) \frac{p_0^{\alpha_0-1}(1-p_0)^{\beta_0-1}}{B(\alpha_0, \beta_0)} \left(1-\sum_{i=1}^{\alpha_J}\frac{\Gamma(\beta_J +i-1)}{\Gamma(\beta_J)\Gamma(i)}p_0^{i-1}(1-p_0)^{\beta_J} \right)  dp_0\\
&amp;= \mathbb{P}(p_0 &gt; max\{p_1,\dots,p_{J-1}\}) - \sum_{i=1}^{\alpha_J}\frac{\Gamma(\beta_J +i-1)}{\Gamma(\beta_J)\Gamma(i)}\int_0^1\prod_{j=1}^{J-1} \mathbb{I}_{p_0}(\alpha_j,\beta_j) \frac{p_0^{\alpha_0 +i-2}(1-p_0)^{\beta_0+\beta_J-1}}{B(\alpha_0,\beta_0)} dp_0 \\
&amp;= \mathbb{P}(p_0 &gt; max\{p_1,\dots,p_{J-1}\}) - \sum_{i=1}^{\alpha_J}\frac{B(\alpha_0 +i-1, \beta_0+\beta_J) \Gamma(\beta_J +i-1)}{B(\alpha_0,\beta_0)\Gamma(\beta_J)\Gamma(i)}\int_0^1 \prod_{j=1}^{J-1} \mathbb{I}_{p_0}(\alpha_j,\beta_j) \frac{p_0^{\alpha_0 +i-2}(1-p_0)^{\beta_0+\beta_J-1}}{B(\alpha_0 +i-1, \beta_0+\beta_J)} dp_0

\end{aligned}\]</span>
<p>where <span class="math inline">\(\mathbb{I}\)</span> is the regularized gamma function. The property used in the second line is: <span class="math inline">\(\mathbb{I}_x(a,b) = 1- \sum_{i=1}^b\frac{\Gamma(a+i-1)}{\Gamma(a)\Gamma(i)}x^a(1-x)^{i-1}\)</span> if <span class="math inline">\(b\)</span> is an integer.</p>
</div>

  </article>

  <br/>

  
  
</section>

      </div>
      
        <footer class="footer">
  <section class="container">
    © 2023 · Lluc Puig Codina

  </section>
</footer>

      
    </main>

    

  <script src="https://llucpuigcodina.github.io/js/app.js"></script>
  
  <script>
  (function($) {
    $(function() {
      $('#privateTrigger').on('click', function() {
        $('.private').slideToggle();
        $('#privateTriggerText').text(" ");
      });
    });
   })(jQuery);
  </script>
  
  </body>
</html>
